<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>KitchenSink • My Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{
          --bg1:#0f172a; --bg2:#1e293b; --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.14);
          --text:#f1f5f9; --muted:#cbd5e1; --brand:#7c3aed; --accent:#06b6d4;
          --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --link:#60a5fa;
          --overlay: rgba(0,0,0,.65); --modal-bg:#0b1220; --modal-border: rgba(255,255,255,.10);
          --field:#121a2a; --field-border:#2a354a;
          color-scheme: dark light;
        }
        *{box-sizing:border-box}
        body{
          margin:0; min-height:100vh; color:var(--text);
          font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          background:
          radial-gradient(1200px 800px at 10% 10%, #1f2937 0%, transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, #111827 0%, transparent 55%),
          linear-gradient(160deg, var(--bg1), var(--bg2));
          padding:2rem; display:grid; gap:1.25rem; justify-items:center;
        }
        .container{ width:min(900px,96vw); display:grid; gap:1rem }
        header{ display:flex; align-items:center; justify-content:space-between; gap:1rem }
        .brand{ display:flex; align-items:center; gap:.75rem }
        .logo{ width:42px; height:42px; border-radius:12px;
          background:linear-gradient(135deg,var(--brand),var(--accent));
          display:grid; place-items:center; font-weight:800; letter-spacing:.4px; color:#fff;
          box-shadow:0 8px 24px rgba(124,58,237,.35);
        }
        h1{ margin:0; font-size:1.35rem }
        .muted{ color:var(--muted); font-size:.95rem }

        .card{
          background-color:var(--card); border:1px solid var(--border);
          border-radius:18px; padding:1.25rem; backdrop-filter: blur(10px);
          box-shadow:0 10px 30px rgba(0,0,0,.20);
        }
        .card h2{ margin:.1rem 0 1rem }

        .kv{ display:grid; grid-template-columns: 9rem 1fr; gap:.5rem 1rem }
        .kv dt{ color:var(--muted); }
        .kv dd{ margin:0 }
        a{ color:var(--link); text-decoration:none }

        .btn{ border:0; border-radius:12px; padding:.8rem 1rem; font-weight:700; cursor:pointer; }
        .btn-ghost{ background:rgba(255,255,255,.08); border:1px solid var(--border); color:var(--text) }
        .btn-primary{
          background:linear-gradient(135deg,var(--brand),var(--accent)); color:#fff;
          box-shadow:0 8px 18px rgba(124,58,237,.35);
        }
        .btn-danger{ background:linear-gradient(135deg,#d946ef,#ef4444); color:#fff }

        .alert{ padding:.75rem 1rem; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.06); }
        .alert.ok { border-color:rgba(34,197,94,.35) }
        .alert.err{ border-color:rgba(239,68,68,.35) }

        .overlay{
          position:fixed; inset:0; background:var(--overlay);
          display:none; align-items:center; justify-content:center; z-index:1000; padding:1rem;
          backdrop-filter: blur(2px);
        }
        .overlay.show{ display:flex }
        .modal{
          width:min(560px,96vw);
          background: var(--modal-bg);
          border: 1px solid var(--modal-border);
          border-radius:18px; padding:1rem 1rem 1.25rem;
          box-shadow: 0 24px 80px rgba(0,0,0,.65);
          animation: pop .18s ease-out;
        }
        .modal header{ align-items:center; padding-bottom: .75rem; border-bottom: 1px solid rgba(255,255,255,.06); }
        .x{ background:transparent; border:0; color:var(--muted); font-size:1.25rem; cursor:pointer }

        label{ font-weight:600; font-size:.95rem }
        .row{ display:grid; gap:.35rem; margin-bottom:.8rem }

        input[type="text"], input[type="email"], input[type="number"]{
          width:100%; padding:.8rem .9rem; color:var(--text);
          background: var(--field);
          border:1px solid var(--field-border); border-radius:12px; outline:none;
        }
        input:focus{
          border-color:rgba(124,58,237,.8);
          box-shadow:0 0 0 3px rgba(124,58,237,.25)
        }
        .field-error{ font-size:.9rem; color:var(--err); min-height:1.1em }
        .field-help{ font-size:.85rem; color:var(--muted) }

        /* +91 input group */
        .input-group { display:flex; align-items:center; gap:.5rem }
        .input-prefix {
          padding:.8rem .9rem; border:1px solid var(--field-border);
          background:var(--field); color:var(--muted); border-radius:12px;
        }
        .input-prefix.fixed { user-select:none }
        .input-group input { flex:1 }

        @keyframes pop{ from{ transform:scale(.98); opacity:.6 } to{ transform:scale(1); opacity:1 } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="brand">
            <div class="logo">KS</div>
            <div>
                <h1>My Profile</h1>
                <div class="muted">Signed in as <span sec:authentication="name">user@example.com</span></div>
            </div>
        </div>

        <form id="logoutForm" th:action="@{/logout}" method="post" style="display:none">
            <input type="hidden" th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </form>

        <button type="button" class="btn btn-ghost"
                onclick="document.getElementById('logoutForm').submit()">
            Logout
        </button>
    </header>

    <!-- flash / query messages -->
    <div th:if="${param.pwdReset}" class="alert ok"><strong>Password updated successfully.</strong></div>
    <div th:if="${msg}" class="alert ok"><strong th:text="${msg}">Saved.</strong></div>
    <div th:if="${param.error}" class="alert err"><strong th:text="${param.error}">Something went wrong.</strong></div>

    <section class="card">
        <h2>Current details</h2>
        <dl class="kv">
            <dt>Name</dt>  <dd th:text="${member.name}">John Doe</dd>
            <dt>Email</dt> <dd th:text="${member.email}">john@example.com</dd>
            <dt>Phone</dt> <dd th:text="${member.phoneNumber}">+919999999999</dd>
            <dt>Age</dt>   <dd th:text="${member.age}">33</dd>
            <dt>Place</dt> <dd th:text="${member.place}">Delhi</dd>
        </dl>
        <p class="muted" style="margin:.8rem 0 1rem">
            Want to change something? Click <em>Update details</em> and submit for admin approval.
        </p>
        <button class="btn btn-primary" id="openEdit">Update details</button>
    </section>

    <section class="card">
        <h2>Delete my account</h2>
        <p class="muted">This sends a deletion request to the admin for approval. Your account won’t be removed until approved.</p>
        <form th:action="@{/member/me/delete}" method="post" onsubmit="return confirm('Send a delete request to admin?');">
            <input type="hidden"
                   th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>
            <button class="btn btn-danger" type="submit">Request account deletion</button>
        </form>
    </section>
</div>

<!-- Edit Modal -->
<div class="overlay" id="editOverlay" aria-hidden="true" aria-labelledby="editTitle" role="dialog">
    <div class="modal">
        <header style="display:flex; justify-content:space-between;">
            <div>
                <h2 id="editTitle" style="margin:.2rem 0;">Update my details</h2>
                <div class="muted" style="margin-top:-.3rem">Edit one or more fields and submit for approval.</div>
            </div>
            <button class="x" id="closeEdit" aria-label="Close">✕</button>
        </header>

        <!-- NOTE: novalidate so we fully control messages -->
        <form th:action="@{/member/me}" method="post" id="updateForm" novalidate>
            <input type="hidden"
                   th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>

            <!-- NAME -->
            <div class="row">
                <label for="name">Name</label>
                <input id="name" name="name" type="text"
                       minlength="1" maxlength="25"
                       th:value="${member.name}" placeholder="Your name (letters only)">
                <div class="field-help">Letters, spaces and punctuation only. Max 25 characters.</div>
                <div class="field-error" data-error-for="name"></div>
            </div>

            <!-- EMAIL -->
            <div class="row">
                <label for="email">Email</label>
                <input id="email" name="email" type="email"
                       th:value="${member.email}" placeholder="you@example.com">
                <div class="field-error" data-error-for="email"></div>
            </div>

            <!-- PHONE with +91 -->
            <div class="row">
                <label for="phoneLocal">Phone</label>
                <div class="input-group">
                    <span class="input-prefix fixed">+91</span>
                    <input id="phoneLocal" name="phoneLocal" type="text"
                           inputmode="numeric" minlength="10" maxlength="10"
                           th:value="${#strings.startsWith(member.phoneNumber, '+91')
                           ? member.phoneNumber.substring(3)
                           : (member.phoneNumber != null && member.phoneNumber.length() == 10
                              ? member.phoneNumber
                              : '')}"
                           placeholder="10 digits">
                </div>
                <!-- Hidden field actually submitted to the server -->
                <input id="phoneNumber" name="phoneNumber" type="hidden"
                       th:value="${#strings.startsWith(member.phoneNumber, '+91')
                         ? member.phoneNumber
                         : ('+91' + (member.phoneNumber != null ? member.phoneNumber : ''))}"/>
                <div class="field-error" data-error-for="phoneNumber"></div>
            </div>

            <!-- AGE -->
            <div class="row">
                <label for="age">Age</label>
                <input id="age" name="age" type="number" min="0" max="120" th:value="${member.age}">
                <div class="field-error" data-error-for="age"></div>
            </div>

            <!-- PLACE -->
            <div class="row" style="margin-bottom:.2rem">
                <label for="place">Place</label>
                <input id="place" name="place" type="text" th:value="${member.place}" maxlength="50" placeholder="City / Town">
                <div class="field-error" data-error-for="place"></div>
            </div>

            <div style="display:flex; gap:.6rem; flex-wrap:wrap; margin-top:.4rem">
                <button id="saveBtn" type="submit" class="btn btn-primary">Submit for approval</button>
                <button type="button" class="btn btn-ghost" id="cancelEdit">Cancel</button>
                <span id="globalMsg" class="muted"></span>
            </div>
        </form>
    </div>
</div>

<script>
    const $ = (s, c=document)=>c.querySelector(s);

    const overlay = $('#editOverlay');
    const openBtn = $('#openEdit');
    const closeBtn = $('#closeEdit');
    const cancelBtn= $('#cancelEdit');
    const form    = $('#updateForm');
    const saveBtn = $('#saveBtn');
    const msg     = $('#globalMsg');

    function openModal(){
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      $('#name', form)?.focus();
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      msg.textContent = '';
      // clear all field errors
      form.querySelectorAll('.field-error').forEach(el => el.textContent = '');
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && overlay.classList.contains('show')) closeModal(); });

    // --- Validation helpers ---
    const setErr = (id, msg) => {
      const box = form.querySelector(`[data-error-for="${id}"]`);
      if (box) box.textContent = msg || '';
    };
    const valName = v => {
      if (!v || !v.trim()) return 'Name is required.';
      if (/\d/.test(v)) return 'Name cannot contain digits.';
      if (v.length > 25) return 'Name must be at most 25 characters.';
      return '';
    };
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const valEmail = v => {
      if (!v || !v.trim()) return 'Email is required.';
      if (!emailRe.test(v.trim())) return 'Enter a valid email like name@example.com.';
      return '';
    };
    const valPhoneLocal = v => {
      const t = (v || '').trim();
      if (t.length !== 10 || !/^\d{10}$/.test(t)) return 'Phone must be exactly 10 digits.';
      return '';
    };
    const valAge = v => {
      if (v === '' || v === null || v === undefined) return ''; // optional
      const n = Number(v);
      if (!Number.isInteger(n)) return 'Age must be a whole number.';
      if (n < 0 || n > 120) return 'Age must be between 0 and 120.';
      return '';
    };
    const valPlace = v => {
      if (!v) return ''; // optional
      if (v.length > 50) return 'Place must be at most 50 characters.';
      return '';
    };

    // Live validation
    const fields = {
      name:   {el: $('#name', form),       fn: valName},
      email:  {el: $('#email', form),      fn: valEmail},
      phoneLocal:{el: $('#phoneLocal', form), fn: valPhoneLocal},
      age:    {el: $('#age', form),        fn: valAge},
      place:  {el: $('#place', form),      fn: valPlace}
    };

    Object.entries(fields).forEach(([id, {el, fn}])=>{
      if (!el) return;
      const handler = () => setErr(id, fn(el.value));
      el.addEventListener('input', handler);
      el.addEventListener('blur', handler);
    });

    function validateAll(){
      // Compose +91 + local into hidden field first (so backend always receives the same format)
      const local = $('#phoneLocal', form)?.value?.trim() ?? '';
      $('#phoneNumber', form).value = local && /^\d{10}$/.test(local) ? ('+91' + local) : '';

      const results = Object.entries(fields).map(([id, {el, fn}])=>{
        const msg = fn(el.value);
        setErr(id === 'phoneLocal' ? 'phoneNumber' : id, msg);
        return {id, ok: !msg};
      });

      // Return the first invalid field to focus
      const firstBad = results.find(r => !r.ok);
      return firstBad ? firstBad.id : null;
    }

    form.addEventListener('submit', (e)=>{
      msg.className = 'muted'; msg.textContent = 'Submitting…';

      const badId = validateAll();
      if (badId){
        e.preventDefault();
        msg.className = ''; msg.style.color = 'var(--err)';
        msg.textContent = 'Please fix the highlighted validation errors.';
        const badEl = fields[badId]?.el;
        badEl?.focus();
        return;
      }
      saveBtn.disabled = true;
    });
function clearAllErrors() {
    form.querySelectorAll('.field-error').forEach(el => el.textContent = '');
  }

  function applyBackendErrors(errors) {
    // Map backend field -> our error placeholders
    // backend uses: name, email, phoneNumber, age, place
    for (const [field, message] of Object.entries(errors || {})) {
      if (field === 'phoneNumber') {
        setErr('phoneNumber', message); // Show under phone field
      } else if (fields[field]) {
        setErr(field, message);
      } else {
        // Unknown field: fall back to global message
        msg.className = '';
        msg.style.color = 'var(--err)';
        msg.textContent = message || 'Validation error.';
      }
    }
    // Focus first field that has an error
    const firstWithErr = Object.keys(errors || {}).find(f => f in fields || f === 'phoneNumber');
    if (firstWithErr) {
      const el = firstWithErr === 'phoneNumber' ? $('#phoneLocal', form) : fields[firstWithErr].el;
      el?.focus();
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault(); // don't navigate away
    clearAllErrors();

    msg.className = 'muted';
    msg.textContent = 'Submitting…';

    // Compose +91 phone and run client-side validation first
    const badId = validateAll();
    if (badId){
      msg.className = '';
      msg.style.color = 'var(--err)';
      msg.textContent = 'Please fix the highlighted validation errors.';
      fields[badId]?.el?.focus();
      return;
    }

    // Prepare form body (includes CSRF hidden field)
    const fd = new FormData(form);
    // Ensure server gets composed +91
    const phoneLocal = fd.get('phoneLocal')?.toString().trim() ?? '';
    fd.set('phoneNumber', phoneLocal ? ('+91' + phoneLocal) : '');
    // Optional: remove the helper field so backend doesn’t see it (harmless if it does)
    fd.delete('phoneLocal');

    // Use URLSearchParams so this matches a normal browser form submit
    const body = new URLSearchParams();
    for (const [k, v] of fd.entries()) body.append(k, v);

    saveBtn.disabled = true;
    try {
      const res = await fetch(form.action, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',           // ask for JSON errors
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'X-Requested-With': 'XMLHttpRequest'   // hint for API-style error responses
        },
        body
      });

      if (res.ok) {
        // success — choose one:
        // 1) reload to show updated values
        window.location.reload();
        // 2) OR close modal & show a success message on the page (uncomment if you prefer)
        // closeModal();
        // msg.className = 'muted';
        // msg.textContent = 'Saved successfully. Awaiting admin approval.';
        return;
      }

      // Not ok: try to parse backend error payload
      let payload = null;
      try { payload = await res.json(); } catch (_) {}
      if (res.status === 400 && payload && payload.errors) {
        msg.className = '';
        msg.style.color = 'var(--err)';
        msg.textContent = payload.detail || 'Please fix the highlighted validation errors.';
        applyBackendErrors(payload.errors);
      } else {
        msg.className = '';
        msg.style.color = 'var(--err)';
        msg.textContent = (payload && (payload.detail || payload.title)) || `Request failed (${res.status}). Please try again.`;
      }
    } catch (err) {
      msg.className = '';
      msg.style.color = 'var(--err)';
      msg.textContent = 'Network error. Please check your connection and try again.';
    } finally {
      saveBtn.disabled = false;
    }
  });
</script>
</body>
</html>
